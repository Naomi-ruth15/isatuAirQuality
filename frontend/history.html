<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Air Quality Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body class="bg-green-50 text-gray-800">

  <div class="max-w-5xl mx-auto p-4">
    <h1 class="text-3xl font-bold mb-6 text-green-800">Air Quality Monitoring Dashboard</h1>

    <!-- Filters -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
      <div>
        <label for="stationSelect" class="block mb-1 font-medium text-green-700">Select Station</label>
        <select id="stationSelect" class="w-full border rounded px-3 py-2" aria-label="Station">
          <option value="">Loading...</option>
        </select>
      </div>

      <div>
        <label for="dateSelectStation" class="block mb-1 font-medium text-green-700">Select Date</label>
        <select id="dateSelectStation" class="w-full border rounded px-3 py-2" aria-label="Date for Station">
          <option value="">Select station first</option>
        </select>
      </div>

      <div class="flex items-end">
        <button id="getAqiBtn" class="bg-green-700 text-white px-4 py-2 rounded hover:bg-green-800 w-full">Get AQI</button>
      </div>
    </div>

    <!-- AQI Output -->
    <div id="aqiOutput" class="bg-white rounded-xl shadow p-6 hidden">
      <h2 class="text-2xl font-semibold mb-2 text-green-700">AQI Result</h2>
      <p><strong>Station:</strong> <span id="outputStation"></span></p>
      <p><strong>Date:</strong> <span id="outputDate"></span></p>
      <p><strong>Score:</strong> <span id="outputScore"></span></p>
      <p><strong>Classification:</strong> <span id="outputClass" class="font-bold"></span></p>
    </div>

    <!-- Line Chart Section -->
    <div class="mt-12">
      <h2 class="text-xl font-semibold mb-2 text-green-800">AQI Trend by Date</h2>

      <div class="mb-4">
        <label for="dateSelectChart" class="block mb-1 font-medium text-green-700">Select Date:</label>
        <select id="dateSelectChart" class="border px-3 py-2 rounded" aria-label="Date for Chart">
          <option value="">Loading dates...</option>
        </select>
      </div>

      <canvas id="aqiChart" class="bg-white rounded-xl shadow p-4"></canvas>

      <!-- Button for Historical Data -->
      <div class="mt-4">
        <button id="historicalDataBtn" class="bg-blue-700 text-white px-4 py-2 rounded hover:bg-blue-800 w-full">Show Historical Data</button>
      </div>
    </div>
  </div>

  <script>
    const baseUrl = window.location.origin.replace(':5500', ':5000'); 

    const stationSelect = document.getElementById('stationSelect');
    const dateSelectStation = document.getElementById('dateSelectStation');
    const getAqiBtn = document.getElementById('getAqiBtn');
    const aqiOutput = document.getElementById('aqiOutput');
    const outputStation = document.getElementById('outputStation');
    const outputDate = document.getElementById('outputDate');
    const outputScore = document.getElementById('outputScore');
    const outputClass = document.getElementById('outputClass');
    const dateSelectChart = document.getElementById('dateSelectChart');
    const historicalDataBtn = document.getElementById('historicalDataBtn');

    async function fetchStations() {
      try {
        const res = await fetch(`${baseUrl}/stations`);
        const stations = await res.json();
        stationSelect.innerHTML = '<option value="">Select Station</option>';
        stations.forEach(station => {
          const option = document.createElement('option');
          option.value = station.stationID;
          option.textContent = station.stationID;
          stationSelect.appendChild(option);
        });
      } catch (err) {
        alert('Failed to load stations.');
        console.error(err);
      }
    }

    async function fetchDates(stationID) {
      try {
        const res = await fetch(`${baseUrl}/dates/${stationID}`);
        const dates = await res.json();
        dateSelectStation.innerHTML = '<option value="">Select Date</option>';
        dates.forEach(date => {
          const option = document.createElement('option');
          option.value = date;
          option.textContent = date;
          dateSelectStation.appendChild(option);
        });
      } catch (err) {
        alert('Failed to load dates for the selected station.');
        console.error(err);
      }
    }

    stationSelect.addEventListener('change', () => {
      const stationID = stationSelect.value;
      if (stationID) {
        fetchDates(stationID);
      } else {
        dateSelectStation.innerHTML = '<option value="">Select station first</option>';
      }
    });

    getAqiBtn.addEventListener('click', async () => {
      const stationID = stationSelect.value;
      const date = dateSelectStation.value;

      if (!stationID || !date) {
        alert('Please select both station and date.');
        return;
      }

      getAqiBtn.disabled = true;
      getAqiBtn.textContent = 'Loading...';

      try {
        const res = await fetch(`${baseUrl}/aqi/${stationID}/${date}`);
        if (!res.ok) throw new Error('No AQI data found');
        const data = await res.json();

        outputStation.textContent = data.stationID;
        outputDate.textContent = data.date;
        outputScore.textContent = data.score;
        outputClass.textContent = data.classification;
        aqiOutput.classList.remove('hidden');
      } catch (err) {
        alert('AQI data not available for this selection.');
        aqiOutput.classList.add('hidden');
        console.error(err);
      } finally {
        getAqiBtn.disabled = false;
        getAqiBtn.textContent = 'Get AQI';
      }
    });

    const ctx = document.getElementById('aqiChart').getContext('2d');
    let aqiChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: [],
        datasets: [{
          label: 'AQI',
          data: [],
          fill: true,
          backgroundColor: 'rgba(34,197,94,0.2)',  // Tailwind green-500 @ 20%
          borderColor: 'rgba(34,197,94,1)',
          pointBackgroundColor: 'rgba(22,163,74,1)',
          tension: 0.3
        }]
      },
      options: {
        responsive: true,
        scales: {
          y: {
            beginAtZero: true,
            title: { display: true, text: 'AQI' }
          },
          x: {
            title: { display: true, text: 'Station ID' }
          }
        }
      }
    });

    function fetchAndRenderAQI() {
      const date = dateSelectChart.value;
      if (!date) return;

      // Make sure to fetch AQI data for all stations on the selected date
      axios.get(`${baseUrl}/aqi/all/${date}`)
        .then(response => {
          const data = response.data;

          // Ensure we have valid data
          if (!data || data.length === 0) {
            alert('No AQI data found for the selected date.');
            return;
          }

          // Extract station IDs and AQI values
          const stationLabels = data.map(entry => entry.stationID);
          const aqiValues = data.map(entry => entry.aqi);

          // Update chart data
          aqiChart.data.labels = stationLabels;
          aqiChart.data.datasets[0].data = aqiValues;
          aqiChart.update();
        })
        .catch(error => {
          console.error('Error fetching AQI data:', error);
          aqiChart.data.labels = [];
          aqiChart.data.datasets[0].data = [];
          aqiChart.update();
        });
    }

    async function fetchAvailableChartDates() {
      try {
        const res = await fetch(`${baseUrl}/dates`);
        const dates = await res.json();
        dateSelectChart.innerHTML = '<option value="">Select Date</option>';
        dates.forEach(date => {
          const opt = document.createElement('option');
          opt.value = date;
          opt.textContent = date;
          dateSelectChart.appendChild(opt);
        });
        fetchAndRenderAQI();
      } catch (err) {
        alert('Failed to load chart dates.');
        console.error(err);
      }
    }

    dateSelectChart.addEventListener('change', fetchAndRenderAQI);

    historicalDataBtn.addEventListener('click', fetchAndRenderAQI);

    window.onload = () => {
      fetchStations();
      fetchAvailableChartDates();
    };
  </script>
</body>
</html>
